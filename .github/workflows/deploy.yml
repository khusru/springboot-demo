name: Deploy to AWS EC2

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  APP_NAME: "demo-app"
  JAR_NAME: "demo-0.0.1-SNAPSHOT.jar"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Setup Java 17
      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Build with Maven
      - name: Build with Maven
        run: |
          mvn clean package -DskipTests
          echo "Build completed!"
          ls -la target/

      # 4. Setup SSH
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 5. Deploy to EC2
      - name: Deploy to EC2
        run: |
          # Create deployment directory
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ~/deploy"
          
          # Copy JAR to EC2
          scp -o StrictHostKeyChecking=no target/${{ env.JAR_NAME }} ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/deploy/
          
          # Create/update systemd service
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo tee /etc/systemd/system/${{ env.APP_NAME }}.service > /dev/null << 'EOF'
  [Unit]
  Description=Demo Spring Boot Application
  After=network.target
  
  [Service]
  Type=simple
  User=ec2-user
  WorkingDirectory=/home/ec2-user
  ExecStart=/usr/bin/java -jar /home/ec2-user/${{ env.JAR_NAME }}
  SuccessExitStatus=143
  TimeoutStopSec=10
  Restart=on-failure
  RestartSec=5
  
  [Install]
  WantedBy=multi-user.target
  EOF"
  
  # Stop service, update JAR, restart
  ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
  # Stop current service
  sudo systemctl stop ${{ env.APP_NAME }} 2>/dev/null || true
  
  # Backup old JAR
  if [ -f ~/${{ env.JAR_NAME }} ]; then
  mv ~/${{ env.JAR_NAME }} ~/${{ env.JAR_NAME }}.backup.$(date +%Y%m%d%H%M%S)
  fi
  
  # Move new JAR
  mv ~/deploy/${{ env.JAR_NAME }} ~/
  
  # Reload systemd
  sudo systemctl daemon-reload
  
  # Enable and start service
  sudo systemctl enable ${{ env.APP_NAME }}
  sudo systemctl start ${{ env.APP_NAME }}
  
  # Wait and check status
  sleep 5
  sudo systemctl status ${{ env.APP_NAME }} --no-pager
  
  # Test application
  curl -f http://localhost:8080/actuator/health || echo 'Health check failed, but continuing...'
  "
  
  # 6. Health Check
  - name: Health Check
run: |
  echo "Waiting for application to start..."
  sleep 10
  curl -f http://${{ secrets.EC2_HOST }}:8080/hello || exit 1
  echo "âœ… Deployment successful!"